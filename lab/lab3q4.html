<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tasmania Web GIS • Lab 3 Q4</title>

<!-- OpenLayers -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.6.1/ol.css" />
<script src="https://cdn.jsdelivr.net/npm/ol@v10.6.1/dist/ol.js"></script>

<!-- Layer Switcher -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol-layerswitcher@4.1.2/dist/ol-layerswitcher.css" />
<script src="https://cdn.jsdelivr.net/npm/ol-layerswitcher@4.1.2/dist/ol-layerswitcher.js"></script>

<style>
  :root{
    --bg:#0f172a;           /* slate-900 */
    --panel:#111827cc;      /* translucent panel */
    --chip:#1f2937cc;
    --text:#e5e7eb;         /* gray-200 */
    --accent:#60a5fa;       /* blue-400 */
    --accent-2:#10b981;     /* emerald-500 */
    --border:#334155;       /* slate-600 */
    --shadow: 0 8px 30px rgba(0,0,0,.25);
  }
  *{ box-sizing:border-box; }
  html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background:#0b1220; color:var(--text);}
  #header{
    display:flex; align-items:center; justify-content:space-between; gap:1rem;
    padding:14px 16px; background:linear-gradient(90deg,#0b1220, #0f172a 35%, #0b1220);
    border-bottom:1px solid var(--border); position:relative; z-index:2;
  }
  .title{margin:0; font-size:18px; font-weight:700; letter-spacing:.3px}
  .subtitle{margin:0; font-size:12px; color:#a3aed1}
  #map{ width:100%; height: calc(100vh - 64px); position:relative; }

  /* Top toolbar */
  .toolbar{
    position:absolute; top:16px; left:50%; transform:translateX(-50%);
    display:flex; flex-wrap:wrap; gap:8px; background:var(--panel);
    border:1px solid var(--border); border-radius:14px; padding:8px 10px;
    backdrop-filter: blur(8px); box-shadow:var(--shadow); z-index:3;
  }
  .tool-chip{
    display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
    background:var(--chip); border:1px solid var(--border); font-size:12px; color:#dbeafe;
  }
  .tool-chip input[type="range"]{ width:110px;}
  .tool-chip button, .tool-chip select{
    background:#0b1220; color:var(--text); border:1px solid var(--border);
    border-radius:999px; padding:6px 10px; cursor:pointer; font-size:12px;
  }
  .tool-chip button:hover{ border-color:var(--accent); }
  .tool-chip input[type="text"]{
    background:#0b1220; color:var(--text); border:1px solid var(--border);
    border-radius:999px; padding:6px 10px; width:220px;
  }

  /* Right side panel for Layers & Legend */
  .sidepanel{
    position:absolute; top:16px; right:16px; width:320px; max-width:90vw; z-index:3;
    display:grid; gap:10px;
  }
  .card{
    background:var(--panel); border:1px solid var(--border); border-radius:16px;
    box-shadow:var(--shadow); overflow:hidden;
  }
  .card h4{
    margin:0; padding:10px 12px; font-size:13px; font-weight:700; letter-spacing:.3px;
    border-bottom:1px solid var(--border); background:#0b1220;
  }
  .card .content{ padding:10px 12px; max-height:40vh; overflow:auto; }

  /* Popup */
  .ol-popup{
    position:absolute; background:#0b1220; color:var(--text);
    padding:10px 12px; border-radius:12px; border:1px solid var(--border);
    min-width:220px; box-shadow:var(--shadow);
  }
  .ol-popup:after, .ol-popup:before{
    top:100%; border:solid transparent; content:" "; height:0; width:0; position:absolute; pointer-events:none;
  }
  .ol-popup:after{
    border-top-color:#0b1220; border-width:10px; left:24px; margin-left:-10px;
  }
  .ol-popup:before{
    border-top-color:var(--border); border-width:11px; left:24px; margin-left:-11px;
  }
  .close-btn{
    position:absolute; right:6px; top:4px; border:none; background:transparent; color:#93a3c6; cursor:pointer; font-size:16px;
  }
  .kv{ display:grid; grid-template-columns:92px 1fr; gap:4px 10px; font-size:12px; }
  .kv div:nth-child(odd){ color:#9fb3d9; }
  .legend-img{ width:100%; height:auto; background:#0b1220; border:1px solid var(--border); border-radius:10px; padding:6px; margin-bottom:8px; }

  /* OpenLayers control accents */
  .ol-scale-line{ background:#0b1220aa; border-color:var(--border); color:#e5e7eb; }
  .ol-zoom, .ol-full-screen, .ol-overviewmap{
    filter: drop-shadow(0 6px 16px rgba(0,0,0,.35));
  }
  .ol-overviewmap .ol-overviewmap-map{ border-radius:12px; }
</style>
</head>
<body>

<div id="header">
  <div>
    <p class="title">Tasmania Web GIS — Lab 3: Question 4</p>
    <p class="subtitle">Author: Monica Layug • Base: Azure Maps • Overlays: Tas Govt WMS (GeoServer)</p>
  </div>
</div>

<div id="map"></div>

<!-- Top toolbar -->
<div class="toolbar" id="toolbar">
  <div class="tool-chip">
    <label for="basemapSel">Basemap</label>
    <select id="basemapSel" title="Change basemap">
      <option value="road">Azure Road</option>
      <option value="satellite">Azure Satellite</option>
      <option value="dark">Azure Dark Gray</option>
    </select>
  </div>

  <div class="tool-chip">
    <label>Carriageways</label>
    <input id="op-carriageways" type="range" min="0" max="1" step="0.05" value="0.9" title="Carriageways opacity" />
  </div>

  <div class="tool-chip">
    <label>Cadastre</label>
    <input id="op-cadastre" type="range" min="0" max="1" step="0.05" value="0.8" title="Cadastre opacity" />
  </div>

  <div class="tool-chip">
    <label>Bus Trips</label>
    <input id="op-bus" type="range" min="0" max="1" step="0.05" value="0.9" title="Bus trips opacity" />
  </div>

  <div class="tool-chip">
    <button id="measureLineBtn" title="Measure distance (ESC to end)">Measure Distance</button>
    <button id="measureAreaBtn" title="Measure area (ESC to end)">Measure Area</button>
    <button id="clearMeasureBtn" title="Clear measurements">Clear</button>
  </div>

  <div class="tool-chip">
    <input id="searchBox" type="text" placeholder="Search Tasmania (town, place)…" />
    <button id="searchBtn">Go</button>
  </div>
</div>

<!-- Right side: Layer switcher + Legend -->
<div class="sidepanel">
  <div class="card">
    <h4>Layers</h4>
    <div class="content" id="layerSwitcherMount"></div>
  </div>
  <div class="card">
    <h4>Legend</h4>
    <div class="content" id="legendBox">
      <em style="color:#9fb3d9">Legends appear for visible layers.</em>
    </div>
  </div>
</div>

<!-- Popup overlay -->
<div id="popup" class="ol-popup" style="display:none;">
  <button class="close-btn" id="popupCloser" title="Close">×</button>
  <div id="popupContent"></div>
</div>

<script>
/** ===== CONFIG ===== **/
const AZURE_KEY = "5XkeavvoPv61d5JlCImnXL0CSVyYmwFx6vkdpDUAVHc6JiNC2pPOJQQJ99BJACYeBjFhIhSbAAAgAZMP4Rzq";
const WMS_URL  = "https://data.stategrowth.tas.gov.au/geoserver/ows";
const PROJ     = ol.proj.get("EPSG:3857"); // Web Mercator for basemaps + WMS tiles
const TAS_CENTER = ol.proj.fromLonLat([146.8, -42.0]); // Hobart-ish center
const INIT_ZOOM = 7;

// WMS layers & legends
const WMS_LAYERS = [
  { id:"carriageways", title:"Carriageways", layer:"ssg:GEO_CARRIAGEWAY", visible:true },
  { id:"cadastre",     title:"Cadastre Parcels", layer:"pam:GEO_CADASTRE", visible:false },
  { id:"bus",          title:"Bus Trips", layer:"ssg:GEO_BRM_TRIP", visible:false }
];

/** ===== BASEMAPS ===== **/
const azureTemplates = {
  road:      `https://atlas.microsoft.com/map/tile?api-version=2022-08-01&tilesetId=microsoft.base.road&zoom={z}&x={x}&y={y}&subscription-key=${AZURE_KEY}`,
  satellite: `https://atlas.microsoft.com/map/tile?api-version=2022-08-01&tilesetId=microsoft.imagery&zoom={z}&x={x}&y={y}&subscription-key=${AZURE_KEY}`,
  dark:      `https://atlas.microsoft.com/map/tile?api-version=2022-08-01&tilesetId=microsoft.base.darkgrey&zoom={z}&x={x}&y={y}&subscription-key=${AZURE_KEY}`
};

const baseRoad = new ol.layer.Tile({
  title:"Azure Maps Road", type:"base", visible:true,
  source: new ol.source.XYZ({ url: azureTemplates.road, maxZoom:19, crossOrigin:"anonymous" })
});
const baseSat = new ol.layer.Tile({
  title:"Azure Satellite", type:"base", visible:false,
  source: new ol.source.XYZ({ url: azureTemplates.satellite, maxZoom:19, crossOrigin:"anonymous" })
});
const baseDark = new ol.layer.Tile({
  title:"Azure Dark Gray", type:"base", visible:false,
  source: new ol.source.XYZ({ url: azureTemplates.dark, maxZoom:19, crossOrigin:"anonymous" })
});

/** ===== WMS OVERLAYS ===== **/
function makeTileWMS(layerName){
  return new ol.layer.Tile({
    title: layerName,
    source: new ol.source.TileWMS({
      url: WMS_URL,
      params: {
        LAYERS: layerName,
        STYLES: "",
        FORMAT: "image/png",
        TRANSPARENT: true,
        VERSION: "1.3.0",
        CRS: "EPSG:3857",
        TILED: true
      },
      serverType: "geoserver",
      crossOrigin: "anonymous"
    })
  });
}

const carriageways = makeTileWMS("ssg:GEO_CARRIAGEWAY");
const cadastre     = makeTileWMS("pam:GEO_CADASTRE");
const busTrips     = makeTileWMS("ssg:GEO_BRM_TRIP");

carriageways.setVisible(true);
carriageways.setOpacity(0.9);
cadastre.setVisible(false);
cadastre.setOpacity(0.8);
busTrips.setVisible(false);
busTrips.setOpacity(0.9);

/** ===== MAP ===== **/
const map = new ol.Map({
  target: "map",
  layers: [
    new ol.layer.Group({ title:"Base Maps", layers:[baseRoad, baseSat, baseDark]}),
    new ol.layer.Group({ title:"Tasmania Overlays", layers:[carriageways, cadastre, busTrips]})
  ],
  view: new ol.View({ center: TAS_CENTER, zoom: INIT_ZOOM, projection: PROJ }),
  controls: ol.control.defaults({ attribution:true }).extend([
    new ol.control.FullScreen(),
    new ol.control.ScaleLine(),
    new ol.control.MousePosition({
      projection: "EPSG:4326",
      coordinateFormat: ol.coordinate.createStringXY(5),
      className: "ol-mouse-position",
      undefinedHTML: "&nbsp;"
    }),
    new ol.control.OverviewMap({
      collapsed:true,
      layers: [ new ol.layer.Tile({
        source: new ol.source.XYZ({ url: azureTemplates.dark, maxZoom: 19 })
      }) ]
    })
  ])
});

/** ===== LAYER SWITCHER (rendered into our card) ===== **/
const ls = new LayerSwitcher({
  activationMode: 'click',
  startActive: true,
  tipLabel: 'Layers',
  groupSelectStyle: 'children'
});
map.addControl(ls);
// Mount the control DOM inside our card for nicer layout
const host = document.getElementById('layerSwitcherMount');
host.appendChild(ls.element);

/** ===== LEGEND MANAGEMENT ===== **/
function legendGraphicURL(layerName){
  const url = new URL(WMS_URL);
  url.searchParams.set("SERVICE", "WMS");
  url.searchParams.set("REQUEST", "GetLegendGraphic");
  url.searchParams.set("FORMAT", "image/png");
  url.searchParams.set("VERSION", "1.3.0");
  url.searchParams.set("LAYER", layerName);
  return url.toString();
}
const legendBox = document.getElementById('legendBox');
function refreshLegends(){
  legendBox.innerHTML = "";
  [[carriageways,"Carriageways (WMS)","ssg:GEO_CARRIAGEWAY"],
   [cadastre,"Cadastre Parcels (WMS)","pam:GEO_CADASTRE"],
   [busTrips,"Bus Trips (WMS)","ssg:GEO_BRM_TRIP"]].forEach(([lyr, label, lname])=>{
    if(lyr.getVisible()){
      const img = document.createElement('img');
      img.src = legendGraphicURL(lname);
      img.alt = label + " legend";
      img.className = "legend-img";
      const cap = document.createElement('div');
      cap.style.fontSize = "12px"; cap.style.marginBottom = "8px"; cap.style.color="#c7d2fe";
      cap.textContent = label;
      legendBox.appendChild(cap);
      legendBox.appendChild(img);
    }
  });
}
[carriageways, cadastre, busTrips].forEach(l=> l.on('change:visible', refreshLegends));
refreshLegends();

/** ===== OPACITY SLIDERS ===== **/
document.getElementById('op-carriageways').addEventListener('input', e=>{
  carriageways.setOpacity(parseFloat(e.target.value));
});
document.getElementById('op-cadastre').addEventListener('input', e=>{
  cadastre.setOpacity(parseFloat(e.target.value));
});
document.getElementById('op-bus').addEventListener('input', e=>{
  busTrips.setOpacity(parseFloat(e.target.value));
});

/** ===== BASEMAP SWITCH ===== **/
document.getElementById('basemapSel').addEventListener('change', (e)=>{
  const v = e.target.value;
  baseRoad.setVisible(v==="road");
  baseSat.setVisible(v==="satellite");
  baseDark.setVisible(v==="dark");
});

/** ===== MEASUREMENT TOOLS ===== **/
const measureSource = new ol.source.Vector();
const measureLayer  = new ol.layer.Vector({
  source: measureSource,
  style: new ol.style.Style({
    stroke: new ol.style.Stroke({ width:2, color:'#93c5fd' }),
    fill:   new ol.style.Fill({ color:'rgba(16,185,129,0.15)' }),
    image:  new ol.style.Circle({ radius:5, fill:new ol.style.Fill({color:'#60a5fa'}) })
  })
});
map.addLayer(measureLayer);

let drawInteraction = null;
function formatLength(line){
  const length = ol.sphere.getLength(line, {projection: PROJ});
  return length > 1000 ? (length/1000).toFixed(2) + ' km' : length.toFixed(1) + ' m';
}
function formatArea(polygon){
  const area = ol.sphere.getArea(polygon, {projection: PROJ});
  return area > 1e6 ? (area/1e6).toFixed(2) + ' km²' : area.toFixed(1) + ' m²';
}
const helpOverlay = new ol.Overlay({
  element: document.createElement('div'),
  offset: [12, -12],
  positioning: 'bottom-left'
});
helpOverlay.getElement().style.cssText = "padding:4px 6px;background:#111827cc;border:1px solid #334155;border-radius:8px;color:#e5e7eb;font:12px/1.2 system-ui;";
map.addOverlay(helpOverlay);

function addMeasure(type){
  removeMeasure();
  drawInteraction = new ol.interaction.Draw({
    source: measureSource,
    type: type,
    style: new ol.style.Style({
      stroke: new ol.style.Stroke({ color:'#60a5fa', width:2 }),
      image: new ol.style.Circle({ radius:5, fill:new ol.style.Fill({ color:'#60a5fa'})})
    })
  });
  let sketch;
  drawInteraction.on('drawstart', (evt)=>{
    sketch = evt.feature;
    helpOverlay.getElement().innerText = "Click to add points, press ESC to finish";
  });
  drawInteraction.on('drawend', ()=>{
    helpOverlay.getElement().innerText = "Measurement finished";
    setTimeout(()=> helpOverlay.getElement().innerText = "", 1200);
  });
  map.addInteraction(drawInteraction);
  map.on('pointermove', (evt)=>{
    if(!sketch){ helpOverlay.setPosition(undefined); return; }
    helpOverlay.setPosition(evt.coordinate);
    const geom = sketch.getGeometry();
    if(geom instanceof ol.geom.Polygon){
      helpOverlay.getElement().innerText = formatArea(geom);
    }else if(geom instanceof ol.geom.LineString){
      helpOverlay.getElement().innerText = formatLength(geom);
    }
  });
}
function removeMeasure(){
  if(drawInteraction){ map.removeInteraction(drawInteraction); drawInteraction = null; }
  map.un('pointermove', ()=>{});
}
document.getElementById('measureLineBtn').onclick = ()=> addMeasure('LineString');
document.getElementById('measureAreaBtn').onclick = ()=> addMeasure('Polygon');
document.getElementById('clearMeasureBtn').onclick = ()=>{
  removeMeasure(); measureSource.clear(); helpOverlay.getElement().innerText="";
};

/** ===== SEARCH (Tasmania-bounded Nominatim) ===== **/
async function searchTas(){
  const q = document.getElementById('searchBox').value.trim();
  if(!q) return;
  // Rough Tasmania bounds (lon/lat): [minx,miny,maxx,maxy] ~ [144,-44,149,-39]
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1&viewbox=144,-44,149,-39&bounded=1`;
  try{
    const res = await fetch(url, { headers: { "Accept":"application/json" }});
    const data = await res.json();
    if(data && data.length){
      const { lon, lat } = data[0];
      const coord = ol.proj.fromLonLat([parseFloat(lon), parseFloat(lat)]);
      map.getView().animate({ center: coord, zoom: 12, duration: 600 });
    }else{
      alert("No result in Tasmania for: " + q);
    }
  }catch(e){
    alert("Search error. Try again.");
  }
}
document.getElementById('searchBtn').onclick = searchTas;
document.getElementById('searchBox').addEventListener('keydown', e=>{ if(e.key==='Enter'){ searchTas(); }});

/** ===== POPUP (WMS GetFeatureInfo) ===== **/
const popupEl = document.getElementById('popup');
const popupContent = document.getElementById('popupContent');
const popupCloser = document.getElementById('popupCloser');
const popupOverlay = new ol.Overlay({
  element: popupEl,
  autoPan: { animation: { duration: 250 } }
});
map.addOverlay(popupOverlay);
popupCloser.onclick = ()=>{ popupOverlay.setPosition(undefined); popupEl.style.display="none"; };

map.on('singleclick', async function(evt){
  // Query the topmost visible WMS overlay first
  const queryOrder = [busTrips, cadastre, carriageways].filter(l=>l.getVisible());
  for(const lyr of queryOrder){
    const src = lyr.getSource();
    const url = src.getFeatureInfoUrl(evt.coordinate, map.getView().getResolution(), PROJ, {
      'INFO_FORMAT': 'application/json',
      'QUERY_LAYERS': src.getParams().LAYERS
    });
    if(!url) continue;
    try{
      const r = await fetch(url);
      if(!r.ok) continue;
      const json = await r.json();
      if(json && json.features && json.features.length){
        const f = json.features[0];
        showPopup(evt.coordinate, f.properties, src.getParams().LAYERS);
        return;
      }
    }catch(e){ /* ignore and try next layer */ }
  }
  // If nothing found, hide popup
  popupOverlay.setPosition(undefined); popupEl.style.display="none";
});

function showPopup(coord, props, layerName){
  popupEl.style.display="block";
  popupOverlay.setPosition(coord);
  const entries = Object.entries(props || {}).slice(0, 12); // keep popup concise
  const html = [
    `<div style="margin-bottom:6px;font-weight:700;color:#bfdbfe;">${layerName}</div>`,
    `<div class="kv">`,
    ...entries.flatMap(([k,v])=> [`<div>${k}</div>`, `<div>${String(v)}</div>`]),
    `</div>`
  ].join("");
  popupContent.innerHTML = html;
}

/** ===== INITIALIZE LEGEND ON LOAD ===== **/
window.addEventListener('load', refreshLegends);
</script>
</body>
</html>
