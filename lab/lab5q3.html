<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenLayers Map with Basemap Switcher, WMS, and Water Features Layer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol/ol.css">
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        /* Custom Control Styling */
        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            font-family: Arial, sans-serif;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="controls">
        <strong>Basemap:</strong><br>
        <label><input type="radio" name="basemap" value="osm" checked> OpenStreetMap</label><br>
        <label><input type="radio" name="basemap" value="esri"> ESRI Imagery</label>
        <hr>
        <label><input type="checkbox" id="wmsToggle"> Show WMS Layer (US States)</label><br>
        <label><input type="checkbox" id="waterToggle"> Show Water Features (USGS)</label>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ol/dist/ol.js"></script>
    <script>
        import Map from 'ol/Map.js';
        import View from 'ol/View.js';
        import TileLayer from 'ol/layer/Tile.js';
        import ImageLayer from 'ol/layer/Image.js'; // Using ImageLayer for WMS, a common OpenLayers pattern
        import OSM from 'ol/source/OSM.js';
        import XYZ from 'ol/source/XYZ.js';
        import TileWMS from 'ol/source/TileWMS.js';
        import ImageWMS from 'ol/source/ImageWMS.js';


        // --- 1. Define Sources ---
        const osmSource = new OSM();
        
        // ESRI World Imagery XYZ Source
        const esriSource = new XYZ({
            attributions: 'Tiles &copy; Esri &mdash; Source: Esri, Earthstar Geographics',
            url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
            maxZoom: 19,
        });

        // WMS Layer Source (topp:states) - Using TileWMS for faster tile-based loading
        const wmsSource = new TileWMS({
            url: 'https://ahocevar.com/geoserver/wms',
            params: { 'LAYERS': 'topp:states', 'TILED': true },
            serverType: 'geoserver',
            crossOrigin: 'anonymous',
        });

        // Water Features Layer Source (USGS National Map) - Using ImageWMS for a single image, sometimes better for complex WMS layers
        const waterSource = new ImageWMS({
            url: 'https://basemap.nationalmap.gov/arcgis/services/USGSHydroCached/MapServer/WMSServer?',
            params: { 'LAYERS': '0', 'FORMAT': 'image/png', 'TRANSPARENT': true },
            crossOrigin: 'anonymous',
        });


        // --- 2. Define Layers ---
        const osmLayer = new TileLayer({ source: osmSource });
        const esriLayer = new TileLayer({ source: esriSource, visible: false }); // Start hidden

        // WMS Layers (start hidden)
        const wmsOverlay = new TileLayer({
            source: wmsSource,
            opacity: 0.6,
            visible: false, 
        });

        const waterOverlay = new ImageLayer({
            source: waterSource,
            opacity: 0.7,
            visible: false,
        });
        
        // --- 3. Initialize Map ---
        const map = new Map({
            target: 'map',
            layers: [
                osmLayer,
                esriLayer,
                wmsOverlay,
                waterOverlay
            ],
            view: new View({
                center: fromLonLat([-98.583, 39.833]), // Center on continental US
                zoom: 4,
            }),
        });

        // Import helper function for coordinate conversion
        import { fromLonLat } from 'ol/proj.js';


        // --- 4. Custom Control Logic ---

        // Basemap switcher logic
        document.querySelectorAll('input[name="basemap"]').forEach((radio) => {
            radio.addEventListener('change', function() {
                if (this.value === 'osm') {
                    osmLayer.setVisible(true);
                    esriLayer.setVisible(false);
                } else if (this.value === 'esri') {
                    osmLayer.setVisible(false);
                    esriLayer.setVisible(true);
                }
            });
        });

        // WMS toggle logic
        document.getElementById('wmsToggle').addEventListener('change', function() {
            wmsOverlay.setVisible(this.checked);
        });

        // Water layer toggle logic
        document.getElementById('waterToggle').addEventListener('change', function() {
            waterOverlay.setVisible(this.checked);
        });
    </script>
</body>
</html>
